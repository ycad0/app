/*! Scroller 1.2.2
 * Â©2011-2014 SpryMedia Ltd - datatables.net/license
 */

/**
 * @summary     Scroller
 * @description Virtual rendering for DataTables
 * @version     1.2.2
 * @file        dataTables.scroller.js
 * @author      SpryMedia Ltd (www.sprymedia.co.uk)
 * @contact     www.sprymedia.co.uk/contact
 * @copyright   Copyright 2011-2014 SpryMedia Ltd.
 *
 * This source file is free software, available under the following license:
 *   MIT license - http://datatables.net/license/mit
 *
 * This source file is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the license files for details.
 *
 * For details please refer to: http://www.datatables.net
 */

(function(e,t,n){var r=function(r,i){"use strict";var s=function(e,n){if(!this instanceof s){alert("Scroller warning: Scroller must be initialised with the 'new' keyword.");return}typeof n=="undefined"&&(n={}),this.s={dt:e,tableTop:0,tableBottom:0,redrawTop:0,redrawBottom:0,autoHeight:!0,viewportRows:0,stateTO:null,drawTO:null,heights:{jump:null,page:null,virtual:null,scroll:null,row:null,viewport:null},topRowFloat:0,scrollDrawDiff:null,loaderVisible:!1},this.s=r.extend(this.s,s.oDefaults,n),this.s.heights.row=this.s.rowHeight,this.dom={force:t.createElement("div"),scroller:null,table:null,loader:null},this.s.dt.oScroller=this,this._fnConstruct()};s.prototype={fnRowToPixels:function(e,t,r){var i;if(r)i=this._domain("virtualToPhysical",e*this.s.heights.row);else{var s=e-this.s.baseRowTop;i=this.s.baseScrollTop+s*this.s.heights.row}return t||t===n?parseInt(i,10):i},fnPixelsToRow:function(e,t,r){var i=e-this.s.baseScrollTop,s=r?this._domain("physicalToVirtual",e)/this.s.heights.row:i/this.s.heights.row+this.s.baseRowTop;return t||t===n?parseInt(s,10):s},fnScrollToRow:function(e,t){var n=this,i=!1,s=this.fnRowToPixels(e),o=(this.s.displayBuffer-1)/2*this.s.viewportRows,u=e-o;u<0&&(u=0),(s>this.s.redrawBottom||s<this.s.redrawTop)&&this.s.dt._iDisplayStart!==u&&(i=!0,s=this.fnRowToPixels(e,!1,!0)),typeof t=="undefined"||t?(this.s.ani=i,r(this.dom.scroller).animate({scrollTop:s},function(){setTimeout(function(){n.s.ani=!1},25)})):r(this.dom.scroller).scrollTop(s)},fnMeasure:function(e){this.s.autoHeight&&this._fnCalcRowHeight();var t=this.s.heights;t.viewport=r(this.dom.scroller).height(),this.s.viewportRows=parseInt(t.viewport/t.row,10)+1,this.s.dt._iDisplayLength=this.s.viewportRows*this.s.displayBuffer,(e===n||e)&&this.s.dt.oInstance.fnDraw()},_fnConstruct:function(){var t=this;if(!this.s.dt.oFeatures.bPaginate){this.s.dt.oApi._fnLog(this.s.dt,0,"Pagination must be enabled for Scroller");return}this.dom.force.style.position="absolute",this.dom.force.style.top="0px",this.dom.force.style.left="0px",this.dom.force.style.width="1px",this.dom.scroller=r("div."+this.s.dt.oClasses.sScrollBody,this.s.dt.nTableWrapper)[0],this.dom.scroller.appendChild(this.dom.force),this.dom.scroller.style.position="relative",this.dom.table=r(">table",this.dom.scroller)[0],this.dom.table.style.position="absolute",this.dom.table.style.top="0px",this.dom.table.style.left="0px",r(this.s.dt.nTableWrapper).addClass("DTS"),this.s.loadingIndicator&&(this.dom.loader=r('<div class="DTS_Loading">'+this.s.dt.oLanguage.sLoadingRecords+"</div>").css("display","none"),r(this.dom.scroller.parentNode).css("position","relative").append(this.dom.loader)),this.s.heights.row&&this.s.heights.row!="auto"&&(this.s.autoHeight=!1),this.fnMeasure(!1),this.s.ingnoreScroll=!0,this.s.stateSaveThrottle=this.s.dt.oApi._fnThrottle(function(){t.s.dt.oApi._fnSaveState(t.s.dt)},500),r(this.dom.scroller).on("scroll.DTS",function(e){t._fnScroll.call(t)}),r(this.dom.scroller).on("touchstart.DTS",function(){t._fnScroll.call(t)}),this.s.dt.aoDrawCallback.push({fn:function(){t.s.dt.bInitialised&&t._fnDrawCallback.call(t)},sName:"Scroller"}),r(e).on("resize.DTS",function(){t.fnMeasure(!1),t._fnInfo()});var n=!0;this.s.dt.oApi._fnCallbackReg(this.s.dt,"aoStateSaveParams",function(e,r){n&&t.s.dt.oLoadedState?(r.iScroller=t.s.dt.oLoadedState.iScroller,r.iScrollerTopRow=t.s.dt.oLoadedState.iScrollerTopRow,n=!1):(r.iScroller=t.dom.scroller.scrollTop,r.iScrollerTopRow=t.s.topRowFloat)},"Scroller_State"),this.s.dt.oLoadedState&&(this.s.topRowFloat=this.s.dt.oLoadedState.iScrollerTopRow||0),this.s.dt.aoDestroyCallback.push({sName:"Scroller",fn:function(){r(e).off("resize.DTS"),r(t.dom.scroller).off("touchstart.DTS scroll.DTS"),r(t.s.dt.nTableWrapper).removeClass("DTS"),r("div.DTS_Loading",t.dom.scroller.parentNode).remove(),t.dom.table.style.position="",t.dom.table.style.top="",t.dom.table.style.left=""}})},_fnScroll:function(){var e=this,t=this.s.heights,n=this.dom.scroller.scrollTop,i;if(this.s.skip)return;if(this.s.ingnoreScroll)return;if(this.s.dt.bFiltered||this.s.dt.bSorted){this.s.lastScrollTop=0;return}this._fnInfo(),clearTimeout(this.s.stateTO),this.s.stateTO=setTimeout(function(){e.s.dt.oApi._fnSaveState(e.s.dt)},250);if(n<this.s.redrawTop||n>this.s.redrawBottom){var s=Math.ceil((this.s.displayBuffer-1)/2*this.s.viewportRows);Math.abs(n-this.s.lastScrollTop)>t.viewport||this.s.ani?(i=parseInt(this._domain("physicalToVirtual",n)/t.row,10)-s,this.s.topRowFloat=this._domain("physicalToVirtual",n)/t.row):(i=this.fnPixelsToRow(n)-s,this.s.topRowFloat=this.fnPixelsToRow(n,!1)),i<=0?i=0:i+this.s.dt._iDisplayLength>this.s.dt.fnRecordsDisplay()?(i=this.s.dt.fnRecordsDisplay()-this.s.dt._iDisplayLength,i<0&&(i=0)):i%2!==0&&i++;if(i!=this.s.dt._iDisplayStart){this.s.tableTop=r(this.s.dt.nTable).offset().top,this.s.tableBottom=r(this.s.dt.nTable).height()+this.s.tableTop;var o=function(){e.s.scrollDrawReq===null&&(e.s.scrollDrawReq=n),e.s.dt._iDisplayStart=i,e.s.dt.oApi._fnCalculateEnd&&e.s.dt.oApi._fnCalculateEnd(e.s.dt),e.s.dt.oApi._fnDraw(e.s.dt)};this.s.dt.oFeatures.bServerSide?(clearTimeout(this.s.drawTO),this.s.drawTO=setTimeout(o,this.s.serverWait)):o(),this.dom.loader&&!this.s.loaderVisible&&(this.dom.loader.css("display","block"),this.s.loaderVisible=!0)}}this.s.lastScrollTop=n,this.s.stateSaveThrottle()},_domain:function(e,t){var n=this.s.heights,r;if(n.virtual===n.scroll){r=(n.virtual-n.viewport)/(n.scroll-n.viewport);if(e==="virtualToPhysical")return t/r;if(e==="physicalToVirtual")return t*r}var i=(n.scroll-n.viewport)/2,s=(n.virtual-n.viewport)/2;r=s/(i*i);if(e==="virtualToPhysical")return t<s?Math.pow(t/r,.5):(t=s*2-t,t<0?n.scroll:i*2-Math.pow(t/r,.5));if(e==="physicalToVirtual")return t<i?t*t*r:(t=i*2-t,t<0?n.virtual:s*2-t*t*r)},_fnDrawCallback:function(){var e=this,t=this.s.heights,n=this.dom.scroller.scrollTop,i=n,s=n+t.viewport,o=r(this.s.dt.nTable).height(),u=this.s.dt._iDisplayStart,a=this.s.dt._iDisplayLength,f=this.s.dt.fnRecordsDisplay();this.s.skip=!0,this._fnScrollForce(),u===0?n=this.s.topRowFloat*t.row:u+a>=f?n=t.scroll-(f-this.s.topRowFloat)*t.row:n=this._domain("virtualToPhysical",this.s.topRowFloat*t.row),this.dom.scroller.scrollTop=n,this.s.baseScrollTop=n,this.s.baseRowTop=this.s.topRowFloat;var l=n-(this.s.topRowFloat-u)*t.row;u===0?l=0:u+a>=f&&(l=t.scroll-o),this.dom.table.style.top=l+"px",this.s.tableTop=l,this.s.tableBottom=o+this.s.tableTop;var c=(n-this.s.tableTop)*this.s.boundaryScale;this.s.redrawTop=n-c,this.s.redrawBottom=n+c,this.s.skip=!1;if(this.s.dt.oFeatures.bStateSave&&this.s.dt.oLoadedState!==null&&typeof this.s.dt.oLoadedState.iScroller!="undefined"){var h=(this.s.dt.sAjaxSource||e.s.dt.ajax)&&!this.s.dt.oFeatures.bServerSide?!0:!1;(h&&this.s.dt.iDraw==2||!h&&this.s.dt.iDraw==1)&&setTimeout(function(){r(e.dom.scroller).scrollTop(e.s.dt.oLoadedState.iScroller),e.s.redrawTop=e.s.dt.oLoadedState.iScroller-t.viewport/2,setTimeout(function(){e.s.ingnoreScroll=!1},0)},0)}else e.s.ingnoreScroll=!1;setTimeout(function(){e._fnInfo.call(e)},0),this.dom.loader&&this.s.loaderVisible&&(this.dom.loader.css("display","none"),this.s.loaderVisible=!1)},_fnScrollForce:function(){var e=this.s.heights,t=1e6;e.virtual=e.row*this.s.dt.fnRecordsDisplay(),e.scroll=e.virtual,e.scroll>t&&(e.scroll=t),this.dom.force.style.height=e.scroll+"px"},_fnCalcRowHeight:function(){var e=this.s.dt,t=e.nTable,n=t.cloneNode(!1),i=r("<tbody/>").appendTo(n),s=r('<div class="'+e.oClasses.sWrapper+' DTS">'+'<div class="'+e.oClasses.sScrollWrapper+'">'+'<div class="'+e.oClasses.sScrollBody+'"></div>'+"</div>"+"</div>");r("tbody tr:lt(4)",t).clone().appendTo(i);while(r("tr",i).length<3)i.append("<tr><td>&nbsp;</td></tr>");r("div."+e.oClasses.sScrollBody,s).append(n);var o;e._bInitComplete?o=t.parentNode:(this.s.dt.nHolding||(this.s.dt.nHolding=r("<div></div>").insertBefore(this.s.dt.nTable)),o=this.s.dt.nHolding),s.appendTo(o),this.s.heights.row=r("tr",i).eq(1).outerHeight(),s.remove()},_fnInfo:function(){if(!this.s.dt.oFeatures.bInfo)return;var e=this.s.dt,t=e.oLanguage,n=this.dom.scroller.scrollTop,i=Math.floor(this.fnPixelsToRow(n,!1,this.s.ani)+1),s=e.fnRecordsTotal(),o=e.fnRecordsDisplay(),u=Math.ceil(this.fnPixelsToRow(n+this.s.heights.viewport,!1,this.s.ani)),a=o<u?o:u,f=e.fnFormatNumber(i),l=e.fnFormatNumber(a),c=e.fnFormatNumber(s),h=e.fnFormatNumber(o),p;e.fnRecordsDisplay()===0&&e.fnRecordsDisplay()==e.fnRecordsTotal()?p=t.sInfoEmpty+t.sInfoPostFix:e.fnRecordsDisplay()===0?p=t.sInfoEmpty+" "+t.sInfoFiltered.replace("_MAX_",c)+t.sInfoPostFix:e.fnRecordsDisplay()==e.fnRecordsTotal()?p=t.sInfo.replace("_START_",f).replace("_END_",l).replace("_MAX_",c).replace("_TOTAL_",h)+t.sInfoPostFix:p=t.sInfo.replace("_START_",f).replace("_END_",l).replace("_MAX_",c).replace("_TOTAL_",h)+" "+t.sInfoFiltered.replace("_MAX_",e.fnFormatNumber(e.fnRecordsTotal()))+t.sInfoPostFix;var d=t.fnInfoCallback;d&&(p=d.call(e.oInstance,e,i,a,s,o,p));var v=e.aanFeatures.i;if(typeof v!="undefined")for(var m=0,g=v.length;m<g;m++)r(v[m]).html(p)}},s.defaults={trace:!1,rowHeight:"auto",serverWait:200,displayBuffer:9,boundaryScale:.5,loadingIndicator:!1},s.oDefaults=s.defaults,s.version="1.2.2",typeof r.fn.dataTable=="function"&&typeof r.fn.dataTableExt.fnVersionCheck=="function"&&r.fn.dataTableExt.fnVersionCheck("1.9.0")?r.fn.dataTableExt.aoFeatures.push({fnInit:function(e){var t=e.oInit,n=t.scroller||t.oScroller||{},r=new s(e,n);return r.dom.wrapper},cFeature:"S",sFeature:"Scroller"}):alert("Warning: Scroller requires DataTables 1.9.0 or greater - www.datatables.net/download"),r.fn.dataTable.Scroller=s,r.fn.DataTable.Scroller=s;if(r.fn.dataTable.Api){var o=r.fn.dataTable.Api;o.register("scroller()",function(){return this}),o.register("scroller().rowToPixels()",function(e,t,n){var r=this.context;if(r.length&&r[0].oScroller)return r[0].oScroller.fnRowToPixels(e,t,n)}),o.register("scroller().pixelsToRow()",function(e,t,n){var r=this.context;if(r.length&&r[0].oScroller)return r[0].oScroller.fnPixelsToRow(e,t,n)}),o.register("scroller().scrollToRow()",function(e,t){return this.iterator("table",function(n){n.oScroller&&n.oScroller.fnScrollToRow(e,t)}),this}),o.register("scroller().measure()",function(e){return this.iterator("table",function(t){t.oScroller&&t.oScroller.fnMeasure(e)}),this})}return s};typeof define=="function"&&define.amd?define(["jquery","datatables"],r):typeof exports=="object"?r(require("jquery"),require("datatables")):jQuery&&!jQuery.fn.dataTable.Scroller&&r(jQuery,jQuery.fn.dataTable)})(window,document);